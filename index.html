<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema POS - Punto de Venta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .nav-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .nav-btn.active {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-success {
            background: linear-gradient(45deg, #2ed573, #1e90ff);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffa726, #ff7043);
        }

        .payment-options {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .payment-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .payment-btn.selected {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .payment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-paid {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-accepted {
            background: #cce5ff;
            color: #004085;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .total-box {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .total-box h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .total-box .amount {
            font-size: 2rem;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            margin-bottom: 20px;
            background: white;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #667eea;
        }

        @media (max-width: 768px) {
            .nav-buttons {
                flex-direction: column;
            }
            
            .payment-options {
                flex-direction: column;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ Sistema POS</h1>
            <p>Punto de Venta Completo</p>
            
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showSection('ventas')">üí∞ Ventas</button>
                <button class="nav-btn" onclick="showSection('creditos')">üìã Cr√©ditos/Deudas</button>
                <button class="nav-btn" onclick="showSection('pedidos')">üì¶ Pedidos</button>
                <button class="nav-btn" onclick="showSection('caja')">üíµ Caja</button>
                <button class="nav-btn" onclick="showSection('reportes')">üìä Reportes</button>
                <button class="nav-btn" onclick="showSection('clientes')">üë• Clientes</button>
            </div>
        </div>

        <!-- Secci√≥n de Ventas -->
        <div id="ventas" class="section active">
            <h2>üí∞ Nueva Venta</h2>
            <div class="grid">
                <div class="card">
                    <div class="form-group">
                        <label>Cliente:</label>
                        <select id="clienteVenta">
                            <option value="general">Cliente General</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Monto de la Venta:</label>
                        <input type="number" id="montoVenta" placeholder="0.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Descripci√≥n (opcional):</label>
                        <textarea id="descripcionVenta" placeholder="Detalles de la venta..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>M√©todo de Pago:</label>
                        <div class="payment-options">
                            <div class="payment-btn selected" onclick="selectPayment('efectivo')">
                                üíµ Efectivo
                            </div>
                            <div class="payment-btn" onclick="selectPayment('tarjeta')">
                                üí≥ Tarjeta
                            </div>
                            <div class="payment-btn" onclick="selectPayment('credito')">
                                üìã Cr√©dito
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="procesarVenta()">‚úÖ Procesar Venta</button>
                </div>
                
                <div class="card">
                    <h3>üíº Resumen del D√≠a</h3>
                    <div class="total-box">
                        <h3>Total Vendido Hoy</h3>
                        <div class="amount" id="totalVentasHoy">$0.00</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <div style="flex: 1; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Efectivo</strong><br>
                            <span id="efectivoHoy">$0.00</span>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Tarjeta</strong><br>
                            <span id="tarjetaHoy">$0.00</span>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <strong>Cr√©dito</strong><br>
                            <span id="creditoHoy">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Cr√©ditos/Deudas -->
        <div id="creditos" class="section">
            <h2>üìã Gesti√≥n de Cr√©ditos y Deudas</h2>
            
            <input type="text" class="search-box" placeholder="üîç Buscar cliente..." onkeyup="filtrarDeudas(this.value)">
            
            <button class="btn btn-warning" onclick="forzarRecargaDatos()" style="margin-bottom: 20px;">
                üîÑ Recargar Datos (Debug)
            </button>
            
            <div class="total-box">
                <h3>Total en Deudas</h3>
                <div class="amount" id="totalDeudas">$0.00</div>
            </div>
            
            <table class="data-table" id="tablaDeudas">
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Deuda Total</th>
                        <th>√öltima Venta</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Secci√≥n de Pedidos -->
        <div id="pedidos" class="section">
            <h2>üì¶ Gesti√≥n de Pedidos</h2>
            
            <div class="grid">
                <div class="card">
                    <h3>‚ûï Nuevo Pedido al Proveedor</h3>
                    <div class="form-group">
                        <label>Nombre del Proveedor:</label>
                        <input type="text" id="nombreProveedor" placeholder="Ingrese el nombre del proveedor">
                    </div>
                    
                    <div class="form-group">
                        <label>Nota del Pedido:</label>
                        <textarea id="notaPedido" placeholder="Detalles del pedido..."></textarea>
                    </div>
                    
                    <button class="btn btn-success" onclick="crearPedido()">üì§ Enviar Pedido</button>
                </div>
                
                <div class="card">
                    <h3>üí∞ Deudas con Proveedores</h3>
                    <div class="total-box">
                        <h3>Total Adeudado</h3>
                        <div class="amount" id="totalProveedores">$0.00</div>
                    </div>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">üìã Lista de Pedidos</h3>
            <table class="data-table" id="tablaPedidos">
                <thead>
                    <tr>
                        <th>Proveedor</th>
                        <th>Fecha</th>
                        <th>Estado</th>
                        <th>Monto</th>
                        <th>Deuda Restante</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Secci√≥n de Caja -->
        <div id="caja" class="section">
            <h2>üíµ Gesti√≥n de Caja</h2>
            
            <div class="grid">
                <div class="card">
                    <h3>üí∞ Dinero Disponible</h3>
                    <div class="total-box">
                        <h3>Efectivo en Caja</h3>
                        <div class="amount" id="dineroDisponible">$0.00</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Monto a Retirar:</label>
                        <input type="number" id="montoRetiro" placeholder="0.00" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Motivo del Retiro:</label>
                        <input type="text" id="motivoRetiro" placeholder="Cierre de caja, gastos, etc.">
                    </div>
                    
                    <button class="btn btn-warning" onclick="retirarDinero()">üí∏ Retirar Dinero</button>
                </div>
                
                <div class="card">
                    <h3>üìä Resumen de Caja</h3>
                    <div style="padding: 20px; background: #f8f9fa; border-radius: 10px; margin: 15px 0;">
                        <p><strong>Ventas en Efectivo Hoy:</strong> <span id="ventasEfectivoHoy">$0.00</span></p>
                        <p><strong>Pagos de Deudas Hoy:</strong> <span id="pagosDeudasHoy">$0.00</span></p>
                        <p><strong>Retiros Realizados:</strong> <span id="retirosHoy">$0.00</span></p>
                        <p><strong>Saldo Actual:</strong> <span id="saldoActual">$0.00</span></p>
                    </div>
                    
                    <button class="btn btn-success" onclick="realizarCierreCaja()">üîí Realizar Cierre de Caja</button>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">üìã Historial de Retiros</h3>
            <table class="data-table" id="tablaRetiros">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Motivo</th>
                        <th>Tipo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Secci√≥n de Reportes -->
        <div id="reportes" class="section">
            <h2>üìä Reportes</h2>
            
            <div class="form-group">
                <label>Filtrar por Fecha:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="fechaInicio">
                    <input type="date" id="fechaFin">
                    <button class="btn" onclick="generarReportes()">üîç Generar Reportes</button>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h3>üí∞ Reporte de Ventas</h3>
                    <div class="total-box">
                        <h3>Total Vendido</h3>
                        <div class="amount" id="reporteTotalVentas">$0.00</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <div style="flex: 1; text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                            <strong>Efectivo</strong><br>
                            <span id="reporteEfectivo">$0.00</span>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 10px; background: #e8f4fd; border-radius: 8px;">
                            <strong>Tarjeta</strong><br>
                            <span id="reporteTarjeta">$0.00</span>
                        </div>
                        <div style="flex: 1; text-align: center; padding: 10px; background: #fff3cd; border-radius: 8px;">
                            <strong>Cr√©dito</strong><br>
                            <span id="reporteCredito">$0.00</span>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìã Reporte de Deudas</h3>
                    <div class="total-box">
                        <h3>Deudas Activas</h3>
                        <div class="amount" id="reporteDeudas">$0.00</div>
                    </div>
                    <p style="text-align: center; margin-top: 10px;">
                        <strong>Pagos Recibidos:</strong> <span id="reportePagos">$0.00</span>
                    </p>
                </div>
                
                <div class="card">
                    <h3>üíµ Reporte de Caja</h3>
                    <div class="total-box">
                        <h3>Efectivo Total Ingresado</h3>
                        <div class="amount" id="reporteEfectivoTotal">$0.00</div>
                    </div>
                    <p style="text-align: center; margin-top: 10px;">
                        <strong>Cierres de Caja:</strong> <span id="reporteCierres">$0.00</span><br>
                        <strong>Retiros Totales:</strong> <span id="reporteRetiros">$0.00</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Clientes -->
        <div id="clientes" class="section">
            <h2>üë• Gesti√≥n de Clientes</h2>
            
            <div class="card">
                <h3>‚ûï Agregar Nuevo Cliente</h3>
                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Nombre del Cliente:</label>
                        <input type="text" id="nombreCliente" placeholder="Nombre completo">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Tel√©fono (opcional):</label>
                        <input type="text" id="telefonoCliente" placeholder="000-000-0000">
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button class="btn btn-success" onclick="agregarCliente()">‚ûï Agregar</button>
                    </div>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">üìã Lista de Clientes</h3>
            <table class="data-table" id="tablaClientes">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Tel√©fono</th>
                        <th>Deuda Actual</th>
                        <th>Total Compras</th>
                        <th>√öltima Compra</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Modales -->
    <div id="modalDeuda" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalDeuda()">&times;</span>
            <h3 id="tituloModalDeuda">Gestionar Deuda</h3>
            <div class="form-group">
                <label>Monto del Pago:</label>
                <input type="number" id="montoPago" placeholder="0.00" step="0.01" min="0">
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-success" onclick="registrarPago()">üí∞ Registrar Pago</button>
                <button class="btn" onclick="cerrarModalDeuda()">‚ùå Cancelar</button>
                <button class="btn btn-warning" onclick="verHistorialDeuda()">üìä Ver Historial</button>
            </div>
        </div>
    </div>

    <div id="modalPedido" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalPedido()">&times;</span>
            <h3 id="tituloModalPedido">Gestionar Pedido</h3>
            <div id="contenidoModalPedido"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, get, update, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase configuration - CORREGIDA
        const firebaseConfig = {
            apiKey: "AIzaSyDsoDE6Ej34PEBAMqIYTjZ4zifRs-PCmAI",
            authDomain: "sistema-de-venta-dbef2.firebaseapp.com",
            databaseURL: "https://sistema-de-venta-dbef2-default-rtdb.firebaseio.com",
            projectId: "sistema-de-venta-dbef2",
            storageBucket: "sistema-de-venta-dbef2.firebasestorage.app",
            messagingSenderId: "987388131167",
            appId: "1:987388131167:web:41dd31553585d7403528ea"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase available globally
        window.firebaseApp = app;
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebasePush = push;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
        window.firebaseOnValue = onValue;

        console.log('Firebase inicializado correctamente con la configuraci√≥n correcta');
        window.initializeApp();
    </script>

    <script>
        // Variables globales
        let metodoPagoSeleccionado = 'efectivo';
        let clienteDeudaActual = null;
        let pedidoActual = null;

        // Datos Firebase
        let db = {
            ventas: {},
            clientes: {},
            deudas: {},
            pedidos: {},
            retiros: {},
            pagosDeuda: {},
            pagosPedidos: {}
        };

        // Inicializaci√≥n de la aplicaci√≥n
        function initializeApp() {
            console.log('Inicializando aplicaci√≥n POS...');
            setupEventListeners();
            loadDataFromFirebase();
            inicializarFechas();
            
            // Inicializar estado del bot√≥n de cr√©dito
            setTimeout(() => {
                const creditoBtn = document.querySelector('.payment-btn[onclick="selectPayment(\'credito\')"]');
                if (creditoBtn) {
                    creditoBtn.style.opacity = '0.5';
                    creditoBtn.style.pointerEvents = 'none';
                    creditoBtn.innerHTML = 'üö´<br><strong>Cr√©dito</strong><br><small>(Solo clientes registrados)</small>';
                }
            }, 1000);
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Cerrar modales al hacer clic fuera
            window.onclick = function(event) {
                const modalDeuda = document.getElementById('modalDeuda');
                const modalPedido = document.getElementById('modalPedido');
                
                if (event.target === modalDeuda) {
                    cerrarModalDeuda();
                }
                if (event.target === modalPedido) {
                    cerrarModalPedido();
                }
            }
        }

        // Cargar datos desde Firebase - CORREGIDO
        function loadDataFromFirebase() {
            console.log('Cargando datos desde Firebase...');
            
            // Cargar ventas
            const ventasRef = window.firebaseRef(window.firebaseDatabase, 'ventas');
            window.firebaseOnValue(ventasRef, (snapshot) => {
                const data = snapshot.val();
                db.ventas = data || {};
                console.log('Ventas cargadas:', db.ventas);
                actualizarResumenVentas();
                actualizarCaja(); // CORREGIDO: Actualizar caja cuando cambien las ventas
                
                // Actualizar reportes si est√° activa esa secci√≥n
                if (document.getElementById('reportes').classList.contains('active')) {
                    setTimeout(generarReportes, 500);
                }
            });

            // Cargar clientes - CORREGIDO para usar la estructura correcta
            const clientesRef = window.firebaseRef(window.firebaseDatabase, 'clientes');
            window.firebaseOnValue(clientesRef, (snapshot) => {
                const data = snapshot.val();
                console.log('Datos de clientes desde Firebase:', data);
                if (data) {
                    db.clientes = data;
                } else {
                    initializeDefaultClients();
                }
                cargarClientes();
                cargarDeudas(); // Cargar deudas despu√©s de cargar clientes
                
                // Actualizar reportes si est√° activa esa secci√≥n
                if (document.getElementById('reportes').classList.contains('active')) {
                    setTimeout(generarReportes, 500);
                }
            });

            // Cargar deudas
            const deudasRef = window.firebaseRef(window.firebaseDatabase, 'deudas');
            window.firebaseOnValue(deudasRef, (snapshot) => {
                const data = snapshot.val();
                db.deudas = data || {};
                cargarDeudas();
            });

            // Cargar pedidos
            const pedidosRef = window.firebaseRef(window.firebaseDatabase, 'pedidos');
            window.firebaseOnValue(pedidosRef, (snapshot) => {
                const data = snapshot.val();
                db.pedidos = data || {};
                console.log('Pedidos cargados:', db.pedidos);
                cargarPedidos();
            });

            // Cargar retiros
            const retirosRef = window.firebaseRef(window.firebaseDatabase, 'retiros');
            window.firebaseOnValue(retirosRef, (snapshot) => {
                const data = snapshot.val();
                db.retiros = data || {};
                actualizarCaja();
                
                // Actualizar reportes si est√° activa esa secci√≥n
                if (document.getElementById('reportes').classList.contains('active')) {
                    setTimeout(generarReportes, 500);
                }
            });

            // Cargar pagos de deuda - CORREGIDO: Actualizar caja cuando cambien los pagos
            const pagosDeudasRef = window.firebaseRef(window.firebaseDatabase, 'pagosDeuda');
            window.firebaseOnValue(pagosDeudasRef, (snapshot) => {
                const data = snapshot.val();
                db.pagosDeuda = data || {};
                console.log('Pagos de deuda cargados:', db.pagosDeuda);
                actualizarCaja(); // Actualizar caja cuando se cargan pagos
                
                // Actualizar reportes si est√° activa esa secci√≥n
                if (document.getElementById('reportes').classList.contains('active')) {
                    setTimeout(generarReportes, 500);
                }
                console.log('Pagos de deuda cargados:', db.pagosDeuda);
                actualizarCaja(); // CORREGIDO: Actualizar caja al cargar pagos de deuda
            });

            // Cargar pagos de pedidos
            const pagosPedidosRef = window.firebaseRef(window.firebaseDatabase, 'pagosPedidos');
            window.firebaseOnValue(pagosPedidosRef, (snapshot) => {
                const data = snapshot.val();
                db.pagosPedidos = data || {};
            });
        }

        // Inicializar clientes por defecto
        function initializeDefaultClients() {
            const defaultClients = {
                'general': {
                    id: 'general',
                    nombre: 'Cliente General',
                    telefono: '',
                    deuda: 0,
                    totalCompras: 0,
                    ultimaCompra: null
                }
            };

            const clientesRef = window.firebaseRef(window.firebaseDatabase, 'clientes');
            window.firebaseSet(clientesRef, defaultClients);
            db.clientes = defaultClients;
        }

        // Funciones de navegaci√≥n
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
            
            // Actualizar datos cuando se cambia de secci√≥n
            if (sectionName === 'ventas') actualizarResumenVentas();
            if (sectionName === 'creditos') {
                forzarRecargaDatos();
                cargarDeudas();
            }
            if (sectionName === 'pedidos') cargarPedidos();
            if (sectionName === 'caja') actualizarCaja();
            if (sectionName === 'reportes') {
                setTimeout(generarReportes, 300);
            }
            if (sectionName === 'clientes') cargarClientes();
        }

        function selectPayment(metodo) {
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            metodoPagoSeleccionado = metodo;
        }

        // Funciones de ventas - CORREGIDAS
        function procesarVenta() {
            const clienteId = document.getElementById('clienteVenta').value;
            const monto = parseFloat(document.getElementById('montoVenta').value);
            const descripcion = document.getElementById('descripcionVenta').value;

            if (!monto || monto <= 0) {
                mostrarAlerta('Por favor ingrese un monto v√°lido', 'error');
                return;
            }

            // Validar que para cr√©dito se requiere cliente registrado
            if (metodoPagoSeleccionado === 'credito' && clienteId === 'general') {
                mostrarAlerta('Para ventas a cr√©dito debe seleccionar un cliente registrado', 'error');
                return;
            }

            const venta = {
                id: Date.now().toString(),
                clienteId: clienteId,
                monto: monto,
                descripcion: descripcion,
                metodoPago: metodoPagoSeleccionado,
                fecha: new Date().toISOString(),
                fechaFormateada: new Date().toLocaleDateString('es-ES')
            };

            console.log('Procesando venta:', venta);

            // Guardar venta en Firebase
            const ventasRef = window.firebaseRef(window.firebaseDatabase, `ventas/${venta.id}`);
            window.firebaseSet(ventasRef, venta);

            // Actualizar cliente si es venta a cr√©dito
            if (metodoPagoSeleccionado === 'credito' && clienteId !== 'general') {
                const clienteRef = window.firebaseRef(window.firebaseDatabase, `clientes/${clienteId}`);
                window.firebaseGet(clienteRef).then((snapshot) => {
                    const cliente = snapshot.val();
                    if (cliente) {
                        const deudaActual = cliente.deuda || 0;
                        const nuevaDeuda = deudaActual + monto;
                        const totalComprasActual = cliente.totalCompras || 0;
                        
                        console.log(`Actualizando cliente ${cliente.nombre}: deuda ${deudaActual} + ${monto} = ${nuevaDeuda}`);
                        
                        const updatedCliente = {
                            ...cliente,
                            deuda: nuevaDeuda,
                            totalCompras: totalComprasActual + monto,
                            ultimaCompra: new Date().toLocaleDateString('es-ES')
                        };

                        window.firebaseSet(clienteRef, updatedCliente).then(() => {
                            console.log('Cliente actualizado exitosamente');
                            // Forzar recarga de deudas despu√©s de actualizar
                            setTimeout(() => {
                                cargarDeudas();
                            }, 500);
                        });
                    }
                });
            }

            // Limpiar formulario
            document.getElementById('montoVenta').value = '';
            document.getElementById('descripcionVenta').value = '';
            document.getElementById('clienteVenta').value = 'general';
            selectPayment('efectivo');
            document.querySelectorAll('.payment-btn')[0].classList.add('selected');
            
            mostrarAlerta('Venta procesada exitosamente', 'success');
        }

        function actualizarResumenVentas() {
            cargarClientes(); // Actualizar select de clientes
            
            const hoy = new Date().toLocaleDateString('es-ES');
            const ventasHoy = Object.values(db.ventas).filter(v => v.fechaFormateada === hoy);
            
            const totalHoy = ventasHoy.reduce((sum, v) => sum + v.monto, 0);
            const efectivoHoy = ventasHoy.filter(v => v.metodoPago === 'efectivo').reduce((sum, v) => sum + v.monto, 0);
            const tarjetaHoy = ventasHoy.filter(v => v.metodoPago === 'tarjeta').reduce((sum, v) => sum + v.monto, 0);
            const creditoHoy = ventasHoy.filter(v => v.metodoPago === 'credito').reduce((sum, v) => sum + v.monto, 0);
            
            document.getElementById('totalVentasHoy').textContent = `$${totalHoy.toFixed(2)}`;
            document.getElementById('efectivoHoy').textContent = `$${efectivoHoy.toFixed(2)}`;
            document.getElementById('tarjetaHoy').textContent = `$${tarjetaHoy.toFixed(2)}`;
            document.getElementById('creditoHoy').textContent = `$${creditoHoy.toFixed(2)}`;
        }

        // Funciones de cr√©ditos y deudas - CORREGIDAS
        function cargarDeudas() {
            console.log('Cargando deudas...');
            console.log('Clientes disponibles:', db.clientes);
            
            const tbody = document.querySelector('#tablaDeudas tbody');
            tbody.innerHTML = '';
            
            let totalDeudas = 0;
            let clientesConDeuda = 0;
            
            // Buscar todos los clientes con deuda > 0
            Object.values(db.clientes).forEach(cliente => {
                const deuda = cliente.deuda || 0;
                console.log(`Cliente: ${cliente.nombre}, Deuda: ${deuda}`);
                
                if (deuda > 0) {
                    totalDeudas += deuda;
                    clientesConDeuda++;
                    
                    console.log('Cliente con deuda encontrado:', cliente.nombre, deuda);
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${cliente.nombre}</td>
                        <td>$${deuda.toFixed(2)}</td>
                        <td>${cliente.ultimaCompra || 'N/A'}</td>
                        <td>
                            <button class="btn btn-success" onclick="abrirModalDeuda('${cliente.id}')">üí∞ Pagar</button>
                            <button class="btn btn-danger" onclick="eliminarDeuda('${cliente.id}')">üóëÔ∏è Eliminar</button>
                        </td>
                    `;
                }
            });
            
            console.log('Total deudas:', totalDeudas);
            console.log('Clientes con deuda:', clientesConDeuda);
            
            document.getElementById('totalDeudas').textContent = `$${totalDeudas.toFixed(2)}`;
            
            if (clientesConDeuda === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="4" style="text-align: center; color: #666; padding: 20px;">
                        No hay deudas registradas
                    </td>
                `;
            }
        }

        function filtrarDeudas(busqueda) {
            const filas = document.querySelectorAll('#tablaDeudas tbody tr');
            filas.forEach(fila => {
                if (fila.cells.length > 1) {
                    const nombreCliente = fila.cells[0].textContent.toLowerCase();
                    if (nombreCliente.includes(busqueda.toLowerCase())) {
                        fila.style.display = '';
                    } else {
                        fila.style.display = 'none';
                    }
                }
            });
        }

        function abrirModalDeuda(clienteId) {
            clienteDeudaActual = clienteId;
            const cliente = db.clientes[clienteId];
            document.getElementById('tituloModalDeuda').textContent = `Gestionar Deuda - ${cliente.nombre}`;
            document.getElementById('modalDeuda').style.display = 'block';
        }

        function cerrarModalDeuda() {
            document.getElementById('modalDeuda').style.display = 'none';
            document.getElementById('montoPago').value = '';
            clienteDeudaActual = null;
        }

        function registrarPago() {
            const monto = parseFloat(document.getElementById('montoPago').value);
            
            if (!monto || monto <= 0) {
                mostrarAlerta('Por favor ingrese un monto v√°lido', 'error');
                return;
            }
            
            const cliente = db.clientes[clienteDeudaActual];
            
            if (monto > cliente.deuda) {
                mostrarAlerta('El monto no puede ser mayor a la deuda', 'error');
                return;
            }
            
            // Registrar pago
            const pagoId = Date.now().toString();
            const pago = {
                id: pagoId,
                clienteId: clienteDeudaActual,
                clienteNombre: cliente.nombre,
                monto: monto,
                fecha: new Date().toISOString(),
                fechaFormateada: new Date().toLocaleDateString('es-ES')
            };

            const pagoRef = window.firebaseRef(window.firebaseDatabase, `pagosDeuda/${pagoId}`);
            window.firebaseSet(pagoRef, pago);
            
            // Reducir deuda
            const nuevaDeuda = cliente.deuda - monto;
            const clienteRef = window.firebaseRef(window.firebaseDatabase, `clientes/${clienteDeudaActual}/deuda`);
            window.firebaseSet(clienteRef, nuevaDeuda).then(() => {
                console.log(`Pago registrado: $${monto} para cliente ${cliente.nombre}`);
                // Actualizar caja inmediatamente despu√©s de registrar el pago
                setTimeout(() => {
                    actualizarCaja();
                }, 500);
            });
            
            mostrarAlerta('Pago registrado exitosamente', 'success');
            cerrarModalDeuda();
        }

        function verHistorialDeuda() {
            const cliente = db.clientes[clienteDeudaActual];
            const pagos = Object.values(db.pagosDeuda).filter(p => p.clienteId === clienteDeudaActual);
            
            let historial = `<h4>Historial de ${cliente.nombre}</h4>`;
            historial += `<p><strong>Deuda Actual:</strong> $${cliente.deuda.toFixed(2)}</p>`;
            historial += `<h5>Pagos Realizados:</h5>`;
            
            if (pagos.length === 0) {
                historial += `<p>No hay pagos registrados</p>`;
            } else {
                historial += `<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <thead>
                        <tr style="background: #f8f9fa;">
                            <th style="padding: 8px; border: 1px solid #ddd;">Fecha</th>
                            <th style="padding: 8px; border: 1px solid #ddd;">Monto</th>
                        </tr>
                    </thead>
                    <tbody>`;
                
                pagos.forEach(pago => {
                    historial += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${pago.fechaFormateada}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">$${pago.monto.toFixed(2)}</td>
                        </tr>`;
                });
                
                historial += `</tbody></table>`;
            }
            
            historial += `<button class="btn" onclick="cerrarModalDeuda()" style="margin-top: 15px;">Cerrar</button>`;
            
            document.getElementById('contenidoModalPedido').innerHTML = historial;
            document.getElementById('modalPedido').style.display = 'block';
        }

        function eliminarDeuda(clienteId) {
            const cliente = db.clientes[clienteId];
            if (confirm(`¬øEst√° seguro de que desea eliminar la deuda de ${cliente.nombre}?`)) {
                // Resetear deuda del cliente
                const clienteRef = window.firebaseRef(window.firebaseDatabase, `clientes/${clienteId}/deuda`);
                window.firebaseSet(clienteRef, 0);
                
                mostrarAlerta('Deuda eliminada exitosamente', 'success');
            }
        }

        // Funciones de pedidos - CORREGIDAS
        function crearPedido() {
            const proveedor = document.getElementById('nombreProveedor').value.trim();
            const nota = document.getElementById('notaPedido').value.trim();
            
            if (!proveedor) {
                mostrarAlerta('Por favor ingrese el nombre del proveedor', 'error');
                return;
            }
            
            if (!nota) {
                mostrarAlerta('Por favor ingrese la nota del pedido', 'error');
                return;
            }
            
            const pedidoId = Date.now().toString();
            const pedido = {
                id: pedidoId,
                proveedor: proveedor,
                nota: nota,
                estado: 'pendiente',
                monto: 0,
                deudaRestante: 0,
                fecha: new Date().toISOString(),
                fechaFormateada: new Date().toLocaleDateString('es-ES')
            };
            
            const pedidoRef = window.firebaseRef(window.firebaseDatabase, `pedidos/${pedidoId}`);
            window.firebaseSet(pedidoRef, pedido);
            
            document.getElementById('nombreProveedor').value = '';
            document.getElementById('notaPedido').value = '';
            
            mostrarAlerta('Pedido enviado exitosamente', 'success');
        }

        function cargarPedidos() {
            const tbody = document.querySelector('#tablaPedidos tbody');
            tbody.innerHTML = '';
            
            let totalProveedores = 0;
            
            Object.values(db.pedidos).forEach(pedido => {
                if (pedido.deudaRestante > 0) {
                    totalProveedores += pedido.deudaRestante;
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${pedido.proveedor}</td>
                    <td>${pedido.fechaFormateada}</td>
                    <td>
                        <span class="status-${pedido.estado}">
                            ${pedido.estado === 'pendiente' ? '‚è≥ Pendiente' : 
                              pedido.estado === 'aceptado' ? '‚úÖ Aceptado' : 
                              '‚úÖ Pagado'}
                        </span>
                    </td>
                    <td>$${pedido.monto.toFixed(2)}</td>
                    <td>$${pedido.deudaRestante.toFixed(2)}</td>
                    <td>
                        ${pedido.estado === 'pendiente' ? 
                            `<button class="btn btn-success" onclick="aceptarPedido('${pedido.id}')">‚úÖ Aceptar</button>` :
                            pedido.deudaRestante > 0 ? 
                            `<button class="btn btn-warning" onclick="pagarPedido('${pedido.id}')">üí∞ Pagar</button>` :
                            '<span style="color: green;">‚úÖ Completado</span>'
                        }
                        <button class="btn btn-danger" onclick="eliminarPedido('${pedido.id}')">üóëÔ∏è Eliminar</button>
                    </td>
                `;
            });
            
            document.getElementById('totalProveedores').textContent = `$${totalProveedores.toFixed(2)}`;
        }

        function aceptarPedido(pedidoId) {
            const monto = prompt('Ingrese el monto total del pedido:');
            
            if (!monto || isNaN(monto) || parseFloat(monto) <= 0) {
                mostrarAlerta('Por favor ingrese un monto v√°lido', 'error');
                return;
            }
            
            const pedidoRef = window.firebaseRef(window.firebaseDatabase, `pedidos/${pedidoId}`);
            window.firebaseGet(pedidoRef).then((snapshot) => {
                const pedido = snapshot.val();
                const updatedPedido = {
                    ...pedido,
                    estado: 'aceptado',
                    monto: parseFloat(monto),
                    deudaRestante: parseFloat(monto)
                };
                window.firebaseSet(pedidoRef, updatedPedido);
            });
            
            mostrarAlerta('Pedido aceptado exitosamente', 'success');
        }

        function pagarPedido(pedidoId) {
            pedidoActual = pedidoId;
            const pedido = db.pedidos[pedidoId];
            
            let contenido = `
                <h4>Pagar Pedido - ${pedido.proveedor}</h4>
                <p><strong>Deuda Restante:</strong> $${pedido.deudaRestante.toFixed(2)}</p>
                <div class="form-group">
                    <label>Monto del Pago:</label>
                    <input type="number" id="montoPagoPedido" placeholder="0.00" step="0.01" min="0" max="${pedido.deudaRestante}">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="procesarPagoPedido()">üí∞ Procesar Pago</button>
                    <button class="btn" onclick="cerrarModalPedido()">‚ùå Cancelar</button>
                </div>
            `;
            
            document.getElementById('contenidoModalPedido').innerHTML = contenido;
            document.getElementById('modalPedido').style.display = 'block';
        }

        function procesarPagoPedido() {
            const monto = parseFloat(document.getElementById('montoPagoPedido').value);
            const pedido = db.pedidos[pedidoActual];
            
            if (!monto || monto <= 0) {
                mostrarAlerta('Por favor ingrese un monto v√°lido', 'error');
                return;
            }
            
            if (monto > pedido.deudaRestante) {
                mostrarAlerta('El monto no puede ser mayor a la deuda restante', 'error');
                return;
            }
            
            // Registrar pago
            const pagoId = Date.now().toString();
            const pago = {
                id: pagoId,
                pedidoId: pedidoActual,
                proveedor: pedido.proveedor,
                monto: monto,
                fecha: new Date().toISOString(),
                fechaFormateada: new Date().toLocaleDateString('es-ES')
            };

            const pagoRef = window.firebaseRef(window.firebaseDatabase, `pagosPedidos/${pagoId}`);
            window.firebaseSet(pagoRef, pago);
            
            // Reducir deuda
            const nuevaDeuda = pedido.deudaRestante - monto;
            const pedidoRef = window.firebaseRef(window.firebaseDatabase, `pedidos/${pedidoActual}`);
            
            const updatedPedido = {
                ...pedido,
                deudaRestante: nuevaDeuda,
                estado: nuevaDeuda <= 0 ? 'pagado' : 'aceptado'
            };
            
            window.firebaseSet(pedidoRef, updatedPedido);
            
            mostrarAlerta('Pago procesado exitosamente', 'success');
            cerrarModalPedido();
        }

        function eliminarPedido(pedidoId) {
            const pedido = db.pedidos[pedidoId];
            if (confirm(`¬øEst√° seguro de que desea eliminar el pedido de ${pedido.proveedor}?`)) {
                const pedidoRef = window.firebaseRef(window.firebaseDatabase, `pedidos/${pedidoId}`);
                window.firebaseRemove(pedidoRef);
                mostrarAlerta('Pedido eliminado exitosamente', 'success');
            }
        }

        function cerrarModalPedido() {
            document.getElementById('modalPedido').style.display = 'none';
            pedidoActual = null;
        }

        // Funciones de caja - CORREGIDAS PARA INCLUIR PAGOS DE DEUDAS
        function actualizarCaja() {
            const hoy = new Date().toLocaleDateString('es-ES');
            
            // Calcular ventas en efectivo del d√≠a
            const ventasEfectivoHoy = Object.values(db.ventas)
                .filter(v => v.fechaFormateada === hoy && v.metodoPago === 'efectivo')
                .reduce((sum, v) => sum + v.monto, 0);
            
            // CORREGIDO: Calcular pagos de deudas del d√≠a (todos los pagos de deudas son en efectivo)
            const pagosDeudasHoy = Object.values(db.pagosDeuda)
                .filter(p => p.fechaFormateada === hoy)
                .reduce((sum, p) => sum + p.monto, 0);
            
            // Calcular retiros del d√≠a
            const retirosHoy = Object.values(db.retiros)
                .filter(r => r.fechaFormateada === hoy)
                .reduce((sum, r) => sum + r.monto, 0);
            
            // CORREGIDO: El dinero disponible incluye ventas en efectivo + pagos de deudas - retiros
            const dineroDisponible = ventasEfectivoHoy + pagosDeudasHoy - retirosHoy;
            
            console.log(`Actualizando caja - Ventas efectivo: $${ventasEfectivoHoy}, Pagos deudas: $${pagosDeudasHoy}, Retiros: $${retirosHoy}, Disponible: $${dineroDisponible}`);
            
            document.getElementById('dineroDisponible').textContent = `$${dineroDisponible.toFixed(2)}`;
            document.getElementById('ventasEfectivoHoy').textContent = `$${ventasEfectivoHoy.toFixed(2)}`;
            document.getElementById('pagosDeudasHoy').textContent = `$${pagosDeudasHoy.toFixed(2)}`;
            document.getElementById('retirosHoy').textContent = `$${retirosHoy.toFixed(2)}`;
            document.getElementById('saldoActual').textContent = `$${dineroDisponible.toFixed(2)}`;
            
            cargarHistorialRetiros();
        }

        function retirarDinero() {
            const monto = parseFloat(document.getElementById('montoRetiro').value);
            const motivo = document.getElementById('motivoRetiro').value.trim();
            
            if (!monto || monto <= 0) {
                mostrarAlerta('Por favor ingrese un monto v√°lido', 'error');
                return;
            }
            
            if (!motivo) {
                mostrarAlerta('Por favor ingrese el motivo del retiro', 'error');
                return;
            }
            
            // Verificar disponibilidad
            const dineroDisponible = parseFloat(document.getElementById('dineroDisponible').textContent.replace('$', '').replace(',', ''));
            
            if (monto > dineroDisponible) {
                mostrarAlerta('No hay suficiente dinero disponible en caja', 'error');
                return;
            }
            
            const retiroId = Date.now().toString();
            const retiro = {
                id: retiroId,
                monto: monto,
                motivo: motivo,
                tipo: 'retiro',
                fecha: new Date().toISOString(),
                fechaFormateada: new Date().toLocaleDateString('es-ES')
            };
            
            const retiroRef = window.firebaseRef(window.firebaseDatabase, `retiros/${retiroId}`);
            window.firebaseSet(retiroRef, retiro);
            
            document.getElementById('montoRetiro').value = '';
            document.getElementById('motivoRetiro').value = '';
            
            mostrarAlerta('Retiro procesado exitosamente', 'success');
        }

        function realizarCierreCaja() {
            const dineroDisponible = parseFloat(document.getElementById('dineroDisponible').textContent.replace('$', '').replace(',', ''));
            
            if (dineroDisponible <= 0) {
                mostrarAlerta('No hay dinero disponible para cerrar caja', 'error');
                return;
            }
            
            const cierreId = Date.now().toString();
            const cierre = {
                id: cierreId,
                monto: dineroDisponible,
                motivo: 'Cierre de caja',
                tipo: 'cierre',
                fecha: new Date().toISOString(),
                fechaFormateada: new Date().toLocaleDateString('es-ES')
            };
            
            const cierreRef = window.firebaseRef(window.firebaseDatabase, `retiros/${cierreId}`);
            window.firebaseSet(cierreRef, cierre);
            
            mostrarAlerta(`Cierre de caja realizado: $${dineroDisponible.toFixed(2)}`, 'success');
        }

        function cargarHistorialRetiros() {
            const tbody = document.querySelector('#tablaRetiros tbody');
            tbody.innerHTML = '';
            
            Object.values(db.retiros).slice().reverse().forEach(retiro => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${retiro.fechaFormateada}</td>
                    <td>$${retiro.monto.toFixed(2)}</td>
                    <td>${retiro.motivo}</td>
                    <td>
                        <span class="status-${retiro.tipo === 'cierre' ? 'accepted' : 'pending'}">
                            ${retiro.tipo === 'cierre' ? 'üîí Cierre' : 'üí∏ Retiro'}
                        </span>
                    </td>
                `;
            });
        }

        // Funciones de reportes - CORREGIDAS PARA INCLUIR PAGOS DE DEUDAS
        function generarReportes() {
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            
            if (!fechaInicio || !fechaFin) {
                // Si no hay fechas, usar el d√≠a actual
                const hoy = new Date();
                const fechaHoy = hoy.toISOString().split('T')[0];
                document.getElementById('fechaInicio').value = fechaHoy;
                document.getElementById('fechaFin').value = fechaHoy;
                generarReportes();
                return;
            }
            
            console.log('Generando reportes para:', fechaInicio, 'a', fechaFin);
            console.log('Datos disponibles:', {
                ventas: Object.keys(db.ventas).length,
                pagosDeuda: Object.keys(db.pagosDeuda).length,
                retiros: Object.keys(db.retiros).length
            });
            
            const inicio = new Date(fechaInicio);
            const fin = new Date(fechaFin);
            fin.setHours(23, 59, 59, 999); // Incluir todo el d√≠a final
            
            // Filtrar datos por fechas
            const ventasFiltradas = Object.values(db.ventas).filter(v => {
                const fechaVenta = new Date(v.fecha);
                const enRango = fechaVenta >= inicio && fechaVenta <= fin;
                if (enRango) {
                    console.log('Venta incluida:', v.monto, v.metodoPago, v.fechaFormateada);
                }
                return enRango;
            });
            
            const pagosFiltrados = Object.values(db.pagosDeuda).filter(p => {
                const fechaPago = new Date(p.fecha);
                const enRango = fechaPago >= inicio && fechaPago <= fin;
                if (enRango) {
                    console.log('Pago incluido:', p.monto, p.fechaFormateada);
                }
                return enRango;
            });
            
            const retirosFiltrados = Object.values(db.retiros).filter(r => {
                const fechaRetiro = new Date(r.fecha);
                return fechaRetiro >= inicio && fechaRetiro <= fin;
            });
            
            // Calcular totales de ventas
            const totalVentas = ventasFiltradas.reduce((sum, v) => sum + v.monto, 0);
            const efectivo = ventasFiltradas.filter(v => v.metodoPago === 'efectivo').reduce((sum, v) => sum + v.monto, 0);
            const tarjeta = ventasFiltradas.filter(v => v.metodoPago === 'tarjeta').reduce((sum, v) => sum + v.monto, 0);
            const credito = ventasFiltradas.filter(v => v.metodoPago === 'credito').reduce((sum, v) => sum + v.monto, 0);
            
            // Calcular deudas y pagos
            const totalPagos = pagosFiltrados.reduce((sum, p) => sum + p.monto, 0);
            const deudasActivas = Object.values(db.clientes).reduce((sum, c) => sum + (c.deuda || 0), 0);
            
            // Calcular efectivo total ingresado (ventas en efectivo + pagos de deudas)
            const efectivoTotalIngresado = efectivo + totalPagos;
            
            // CORREGIDO: Calcular efectivo total (ventas + pagos de deudas)
            const efectivoTotal = efectivo + totalPagos;
            
            // Calcular cierres
            const cierres = retirosFiltrados.filter(r => r.tipo === 'cierre').reduce((sum, r) => sum + r.monto, 0);
            const retiros = retirosFiltrados.filter(r => r.tipo === 'retiro').reduce((sum, r) => sum + r.monto, 0);
            
            console.log('Resultados calculados:', {
                totalVentas,
                efectivo,
                tarjeta,
                credito,
                totalPagos,
                efectivoTotalIngresado,
                deudasActivas,
                cierres,
                retiros
            });
            
            // Mostrar resultados
            document.getElementById('reporteTotalVentas').textContent = `$${totalVentas.toFixed(2)}`;
            document.getElementById('reporteEfectivo').textContent = `$${efectivo.toFixed(2)}`;
            document.getElementById('reporteTarjeta').textContent = `$${tarjeta.toFixed(2)}`;
            document.getElementById('reporteCredito').textContent = `$${credito.toFixed(2)}`;
            
            document.getElementById('reporteDeudas').textContent = `$${deudasActivas.toFixed(2)}`;
            document.getElementById('reportePagos').textContent = `$${totalPagos.toFixed(2)}`;
            
            // CORREGIDO: Mostrar efectivo total ingresado
            document.getElementById('reporteEfectivoTotal').textContent = `$${efectivoTotal.toFixed(2)}`;
            document.getElementById('reporteCierres').textContent = `$${efectivoTotalIngresado.toFixed(2)}`;
            document.getElementById('reporteRetiros').textContent = `$${retiros.toFixed(2)}`;
            
            mostrarAlerta(`Reportes generados para el per√≠odo ${fechaInicio} - ${fechaFin}`, 'success');
        }

        // Funciones de clientes
        function agregarCliente() {
            const nombre = document.getElementById('nombreCliente').value.trim();
            const telefono = document.getElementById('telefonoCliente').value.trim();
            
            if (!nombre) {
                mostrarAlerta('Por favor ingrese el nombre del cliente', 'error');
                return;
            }
            
            // Verificar si el cliente ya existe
            const clienteExiste = Object.values(db.clientes).find(c => c.nombre.toLowerCase() === nombre.toLowerCase());
            if (clienteExiste) {
                mostrarAlerta('Ya existe un cliente con ese nombre', 'error');
                return;
            }
            
            const clienteId = Date.now().toString();
            const cliente = {
                id: clienteId,
                nombre: nombre,
                telefono: telefono,
                deuda: 0,
                totalCompras: 0,
                ultimaCompra: null
            };
            
            const clienteRef = window.firebaseRef(window.firebaseDatabase, `clientes/${clienteId}`);
            window.firebaseSet(clienteRef, cliente);
            
            document.getElementById('nombreCliente').value = '';
            document.getElementById('telefonoCliente').value = '';
            
            mostrarAlerta('Cliente agregado exitosamente', 'success');
        }

        function cargarClientes() {
            // Actualizar select de ventas
            const selectVentas = document.getElementById('clienteVenta');
            selectVentas.innerHTML = '<option value="general">Cliente General</option>';
            
            Object.values(db.clientes).forEach(cliente => {
                if (cliente.id !== 'general') {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nombre;
                    selectVentas.appendChild(option);
                }
            });

            // Agregar event listener para controlar m√©todos de pago
            selectVentas.addEventListener('change', function() {
                const creditoBtn = document.querySelector('.payment-btn[onclick="selectPayment(\'credito\')"]');
                if (this.value === 'general') {
                    // Deshabilitar cr√©dito para cliente general
                    creditoBtn.style.opacity = '0.5';
                    creditoBtn.style.pointerEvents = 'none';
                    creditoBtn.innerHTML = 'üö´<br><strong>Cr√©dito</strong><br><small>(Solo clientes registrados)</small>';
                    
                    // Si estaba seleccionado cr√©dito, cambiar a efectivo
                    if (metodoPagoSeleccionado === 'credito') {
                        selectPayment('efectivo');
                        document.querySelectorAll('.payment-btn')[0].classList.add('selected');
                        creditoBtn.classList.remove('selected');
                    }
                } else {
                    // Habilitar cr√©dito para clientes registrados
                    creditoBtn.style.opacity = '1';
                    creditoBtn.style.pointerEvents = 'auto';
                    creditoBtn.innerHTML = 'üìù<br><strong>Cr√©dito</strong>';
                }
            });
            
            // Actualizar tabla de clientes
            if (document.getElementById('clientes').classList.contains('active')) {
                const tbody = document.querySelector('#tablaClientes tbody');
                tbody.innerHTML = '';
                
                Object.values(db.clientes).forEach(cliente => {
                    if (cliente.id !== 'general') {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${cliente.nombre}</td>
                            <td>${cliente.telefono || 'No registrado'}</td>
                            <td>$${(cliente.deuda || 0).toFixed(2)}</td>
                            <td>$${(cliente.totalCompras || 0).toFixed(2)}</td>
                            <td>${cliente.ultimaCompra || 'Nunca'}</td>
                            <td>
                                <button class="btn btn-danger" onclick="eliminarCliente('${cliente.id}')">üóëÔ∏è Eliminar</button>
                            </td>
                        `;
                    }
                });
            }
        }

        function eliminarCliente(clienteId) {
            const cliente = db.clientes[clienteId];
            
            if (cliente.deuda > 0) {
                mostrarAlerta('No se puede eliminar un cliente con deuda pendiente', 'error');
                return;
            }
            
            if (confirm(`¬øEst√° seguro de que desea eliminar al cliente ${cliente.nombre}?`)) {
                const clienteRef = window.firebaseRef(window.firebaseDatabase, `clientes/${clienteId}`);
                window.firebaseRemove(clienteRef);
                
                mostrarAlerta('Cliente eliminado exitosamente', 'success');
            }
        }

        // Funci√≥n para mostrar alertas
        function mostrarAlerta(mensaje, tipo) {
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo === 'success' ? 'success' : 'error'}`;
            alerta.innerHTML = mensaje;
            
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                alerta.remove();
            }, 3000);
        }

        // Inicializar fechas en reportes
        function inicializarFechas() {
            const hoy = new Date();
            const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            
            document.getElementById('fechaInicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('fechaFin').value = hoy.toISOString().split('T')[0];
        }

        function forzarRecargaDatos() {
            console.log('Forzando recarga de datos...');
            
            // Recargar clientes
            const clientesRef = window.firebaseRef(window.firebaseDatabase, 'clientes');
            window.firebaseGet(clientesRef).then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    db.clientes = data;
                    console.log('Clientes recargados:', db.clientes);
                    cargarDeudas();
                }
            });
        }

        // Hacer la funci√≥n disponible globalmente
        window.initializeApp = initializeApp;

        // Generar reportes autom√°ticamente al cargar
        setTimeout(() => {
            if (document.getElementById('reportes').classList.contains('active')) {
                generarReportes();
            }
        }, 3000);
    </script>
</body>
</html>
